<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cyclist Scatterplot Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #1c1c1c;
        color: #fff;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1#title {
        font-size: clamp(20px, 3vw, 32px);
        text-decoration: underline;
        text-decoration-color: #e63946;
        margin: 20px 0;
        text-align: center;
      }

      #chart-container {
        width: 100%;
        max-width: 1200px;
        padding: 10px;
      }

      svg {
        width: 100%;
        height: auto;
        background: #dcdcdc;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        display: block;
      }

      .dot {
        transition: fill 0.2s, r 0.2s;
        stroke: #222;
        stroke-width: 1px;
        cursor: pointer;
      }
      .dot:hover {
        fill: orange;
        r: 7;
      }

      #tooltip {
        position: absolute;
        opacity: 0;
        background: #fff;
        color: #000;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #333;
        font-size: clamp(10px, 1.5vw, 14px);
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        z-index: 10;
      }

      .axis path,
      .axis line {
        stroke: #333;
      }

      .axis text {
        fill: #111;
      }

      /* Mobile legend container */
      #legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 10px 0;
        flex-wrap: wrap;
      }

      #legend div {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      /* Mobile legend text color updated for readability */
      #legend div span {
        color: #eee; /* light text on dark background */
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <h1 id="title">Cyclist Scatterplot Graph</h1>
    <div id="chart-container">
      <svg></svg>
    </div>
    <div id="tooltip"></div>
    <div id="legend"></div>

    <script>
      const url =
        "https://raw.githubusercontent.com/freeCodeCamp/ProjectReferenceData/master/cyclist-data.json";

      d3.json(url).then((dataset) => {
        const data = dataset;
        const svg = d3.select("svg");
        const tooltip = d3.select("#tooltip");

        function drawChart() {
          svg.selectAll("*").remove();
          d3.select("#legend").selectAll("*").remove();

          const w = parseInt(svg.style("width"));
          const h = w * 0.6; // maintain aspect ratio
          svg.attr("height", h);

          const paddingLeft = Math.max(60, w * 0.08);
          const paddingRight = 40;
          const paddingTop = 20;
          const paddingBottom = 60;

          // Scales
          const xScale = d3
            .scaleTime()
            .domain([
              d3.min(data, (d) => new Date(d.Year, 0, 1)),
              d3.max(data, (d) => new Date(d.Year, 0, 1)),
            ])
            .range([paddingLeft, w - paddingRight]);

          const yScale = d3
            .scaleTime()
            .domain([
              d3.min(data, (d) => {
                const [min, sec] = d.Time.split(":").map(Number);
                return new Date(1970, 0, 1, 0, min, sec);
              }),
              d3.max(data, (d) => {
                const [min, sec] = d.Time.split(":").map(Number);
                return new Date(1970, 0, 1, 0, min, sec);
              }),
            ])
            .range([h - paddingBottom, paddingTop]);

          // Axes
          const xAxis = d3
            .axisBottom(xScale)
            .ticks(Math.min(data.length, Math.floor(w / 80)));
          const yAxis = d3
            .axisLeft(yScale)
            .tickFormat(d3.timeFormat("%M:%S"))
            .ticks(w < 500 ? 5 : 10);

          svg
            .append("g")
            .attr("id", "x-axis")
            .attr("class", "axis")
            .attr("transform", `translate(0,${h - paddingBottom})`)
            .call(xAxis)
            .selectAll("text")
            .style("font-size", Math.max(8, w / 100) + "px");

          svg
            .append("g")
            .attr("id", "y-axis")
            .attr("class", "axis")
            .attr("transform", `translate(${paddingLeft},0)`)
            .call(yAxis)
            .selectAll("text")
            .style("font-size", Math.max(8, w / 100) + "px");

          // Dots
          const dotRadius = w < 600 ? 3 : 5;
          svg
            .selectAll(".dot")
            .data(data)
            .enter()
            .append("circle")
            .attr("class", "dot")
            .attr("cx", (d) => xScale(new Date(d.Year, 0, 1)))
            .attr("cy", (d) => {
              const [min, sec] = d.Time.split(":").map(Number);
              return yScale(new Date(1970, 0, 1, 0, min, sec));
            })
            .attr("r", dotRadius)
            .attr("fill", (d) => (d.Doping ? "#e63946" : "#1f77b4"))
            .attr("data-xvalue", (d) => d.Year)
            .attr("data-yvalue", (d) => d.Time)
            .on("mouseover", (event, d) => showTooltip(event, d))
            .on("mouseout", () => tooltip.style("opacity", 0))
            .on("click", (event, d) => {
              const visible = tooltip.style("opacity") == 1;
              showTooltip(event, d, !visible);
            });

          // Axis labels
          svg
            .append("text")
            .attr("x", w / 2)
            .attr("y", h - 20)
            .attr("text-anchor", "middle")
            .text("Year");

          svg
            .append("text")
            .attr("transform", "rotate(-90)")
            .attr("x", -h / 2)
            .attr("y", 40)
            .attr("text-anchor", "middle")
            .text("Time (MM:SS)");

          drawLegend(w);
        }

        // Tooltip function
        function showTooltip(event, d, forceShow = false) {
          let left = event.pageX + 10;
          let top = event.pageY - 28;
          const tooltipWidth = 180;
          if (left + tooltipWidth > window.innerWidth)
            left = event.pageX - tooltipWidth - 10;
          if (top < 0) top = event.pageY + 10;

          tooltip
            .style("opacity", forceShow ? 1 : 1)
            .html(
              `<strong>${d.Name}</strong><br>Year: ${d.Year}<br>Time: ${
                d.Time
              }<br>${d.Doping ? d.Doping : "No doping allegations"}`
            )
            .attr("data-year", d.Year)
            .style("left", left + "px")
            .style("top", top + "px");
        }

        // Draw legend
        function drawLegend(w) {
          const legendDiv = d3.select("#legend");
          const legendData = [
            { color: "#e63946", text: "Doping allegations" },
            { color: "#1f77b4", text: "No doping allegations" },
          ];

          if (w < 700) {
            // Mobile: legend below SVG with light text
            legendDiv
              .style("display", "flex")
              .style("justify-content", "center")
              .style("gap", "20px")
              .style("flex-wrap", "wrap");

            legendData.forEach((d) => {
              const item = legendDiv.append("div");
              item
                .append("div")
                .style("width", "15px")
                .style("height", "15px")
                .style("background-color", d.color)
                .style("border", "1px solid #333");
              item.append("span").text(d.text); // light color applied via CSS
            });
          } else {
            // Desktop: legend inside SVG
            const legend = svg.append("g").attr("id", "legend");
            const spacing = 25;
            const startX = w - 200;
            const startY = 20;

            legendData.forEach((d, i) => {
              const yPos = startY + i * spacing;
              legend
                .append("rect")
                .attr("x", startX)
                .attr("y", yPos)
                .attr("width", 15)
                .attr("height", 15)
                .attr("fill", d.color);
              legend
                .append("text")
                .attr("x", startX + 20)
                .attr("y", yPos + 12)
                .text(d.text)
                .style("fill", "#111");
            });
          }
        }

        drawChart();
        window.addEventListener("resize", drawChart);
      });
    </script>
  </body>
</html>
